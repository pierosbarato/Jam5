<html lang="en">
<head>
<meta charset="utf-8">
<meta name = "viewport" content = "width=device-width, minimum-scale=1.0, maximum-scale = 1.0, user-scalable = no">
<title>Jam Edit</title>
<style type="text/css">
	:root {--nest-size: 25px;}
	:root {--nest-size2: 18px;}
</style>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
<!-- Bootstrap core CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet">
<!-- Material Design Bootstrap -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.0/css/mdb.min.css" rel="stylesheet">

<link rel="stylesheet"
	href="bootstrap-iconpicker/css/bootstrap-iconpicker.min.css">

<link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />

<style>
@media only screen and (max-width: 600px) {
	.select2-container--open
	.select2-dropdown--below {
		position: fixed !important;
		top: 1px !important;
		width: 100% !important;
		height: calc(70vh - 1px) !important;
	}
	.select2-results {
//		visibility: hidden;
	}
	.select2-container .select2-dropdown
	.select2-results .select2-results__options {
		max-height: calc(70vh - 131px);
	}
}
</style>

<link rel="stylesheet" href="nest.css">
<link rel="stylesheet" href="main.css">

<style type="text/css">
body {
	padding: 1em;
	background-color:rgba(29,112,221,0.9);
	background-color:white;
}

.btn.btn-sm {
	padding: .2rem .3rem;
	font-size: .64rem;
}

label, input, button, select, textarea {
	font-weight:450;
/*	font-size:20px; */
	color:#12488c;
}
.container {
	padding: 0px;
	max-width:1000px;
}
@media (min-width: 1200px) {
.container {
	padding: 0px;
	max-width:1200px;
}}
.dd-list .dd-list {
/*	border-style: dashed; */
}
.jamEdit {
	width: 100px;
	height: 19px;
	border: 0px;
	margin: 0px 0px 0px 0px;
	padding: 0px 0px 0px 0px;
	box-sizing: border-box;
}

.jamButton {
	margin: -4px;
}

.select2-container--open .select2-dropdown--below {
	border-top: 1px;
}

.select2-container
.select2-selection--single {
	height: 24px;
}

.select2-container--default
.select2-selection--single
.select2-selection__rendered {
	line-height: 24px;
	padding-top: -1px;
}
.select2-results__option {
	padding: 0px;
}
</style>
</head>
<body>
	<menu id="nestable-menu">
		<a class="btn btn-success" href="../" target="_self"> <i
			class="fas fa-home"></i>&nbsp;
		</a>
		<button type="button" class="btn btn-success" data-action="expand-all">
			<i class="fas fa-plus"></i><i class="fas fa-plus"></i>&nbsp;
		</button>
		<button type="button" class="btn btn-success"
			data-action="collapse-all">
			<i class="fas fa-minus"></i><i class="fas fa-minus"></i>&nbsp;
		</button>
<!--	<button type="button" class="btn btn-success"
			data-action="add-item">Add</button>
		<button type="button" class="btn btn-success"
			data-action="replace-item">Replace</button>  -->
		<button type="button" id="load" class="btn btn-success">
			<i class="fas fa-download"></i>&nbsp;
		</button>
		<button type="button" id="save" class="btn btn-success">
			<i class="fas fa-save"></i>&nbsp;
		</button>
		<a class="btn btn-success"
			href="//pdfcrowd.com/url_to_pdf/?footer_text=$u&pdf_name=page.pdf">
			<i class="fas fa-file-pdf"></i>&nbsp;
		</a>
		<a class="btn btn-success" href="/Jam5/server/excel"> <i
			class="fas fa-file-excel"></i>&nbsp;
		</a>
		<a class="btn btn-success" onclick="window.print();return false;">
			<i class="fas fa-print"></i>&nbsp;
		</a>
		<button type="button" id="formula" class="btn btn-success">
			<i class="fas fa-calculator"></i>&nbsp;
		</button>
		<button type="button" id="find" class="btn btn-success">
			<i class="fas fa-search"></i>&nbsp;
		</button>
	</menu>

	<div class="container">
				
		<div class="row">
			<div class="col-md-6">
				<div>Pane:
				<select class="form-control col-md-6" id="item-select"
					onChange="carica('load');"
					style=""></select>
				</div>
	 			<div class="dd" id="nestable-load"></div>
			</div>
			<div class="col-md-6">
				<div>Browse</div>
				<div class="dd" id="nestable-find">Premere Ricerca</div>
			</div>

		</div>

	</div>

	<textarea id="nestable-output-load"></textarea>
	<textarea id="nestable-output-find"></textarea>
<!-- 
	<div class="cf nestable-lists">
		<div class="dd" id="nestable3">
			<ol class="dd-list">
				<li class="dd-item dd3-item" data-id="13">
					<div class="dd-handle dd3-handle fas fa-address-card">
					</div>
					<div class="dd3-content">
						Pane id: <input class="jamEdit" style="width: 50px"></input> tit:
						<input class="jamEdit"></input>
						<div class="btn-group float-right jamButton">
							<a class="btn btn-secondary btn-sm btnDown btnMove clickable">
								<i class="fas fa-angle-down clickable"></i>
							</a> <a class="btn btn-primary btn-sm btnEdit clickable"
								data-toggle="modal" data-target="#menuEditModal"> <i
								class="fas fa-edit clickable"></i>
							</a> <a class="btn btn-danger btn-sm btnRemove clickable">
							<i class="fas fa-trash-alt clickable"></i>
							</a>
						</div>
					</div>
				</li>
				<li class="dd-item dd3-item" data-id="14">
					<div class="dd-handle dd3-handle">
						<i class="fas fa-address-card"></i>
						</div>
					<div class="dd3-content">Item 14</div>
				</li>
				<li class="dd-item dd3-item dd-collapsed" data-id="15">
					<div class="dd-handle dd3-handle"><i class="fas fa-address-card"></i></div>
					<div class="dd3-content">Item 15</div>
					<ol class="dd-list">
						<li class="dd-item dd3-item" data-id="16">
							<div class="dd-handle dd3-handle"><i class="fas fa-address-card"></i></div>
							<div class="dd3-content">Item 16</div>
						</li>
						<li class="dd-item dd3-item" data-id="17">
							<div class="dd-handle dd3-handle"><i class="fas fa-address-card"></i></div>
							<div class="dd3-content">Item 17</div>
						</li>
						<li class="dd-item dd3-item" data-id="18">
							<div class="dd-handle dd3-handle"><i class="fas fa-address-card"></i></div>
							<div class="dd3-content">Item 18</div>
						</li>
					</ol>
				</li>
			</ol>
		</div>
	</div>
 -->
<!--
<script type="text/javascript"
	src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js'></script>
<script type="text/javascript"
	src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.bundle.min.js"></script>
 -->
<!-- JQuery -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<!-- Bootstrap tooltips -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/umd/popper.min.js"></script>
<!-- Bootstrap core JavaScript -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/js/bootstrap.min.js"></script>
<!-- MDB core JavaScript -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.0/js/mdb.min.js"></script>


<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>

<script type="text/javascript"
	src="bootstrap-iconpicker/js/iconset/fontawesome5-3-1.min.js"></script>
<script type="text/javascript"
	src="bootstrap-iconpicker/js/bootstrap-iconpicker.min.js"></script>

	<script src="nest.js"></script>

	<script>
		$("#find").click(function() {
			carica('find');
		});

		$("#load").click(function() {
			carica('load');
		});

		$("#formula").click(function() {
			carica('load:formula');
		});

		var caricaLoad = 0;
		var caricaFind = 0;
		var carica = function(modo) {
			console.profile();
			var cc = null;
			if (modo.substring(0, 4) == "load") {
				if (caricaLoad > 0) {
					cc = $('#nestable-load').nestable('destroy');
				}
				caricaLoad++;
			}
			if (modo == "find") {
				if (caricaFind > 0) {
					$('#nestable-find').nestable('destroy');
				}
				caricaFind++;
			}

			$.get("/Jam5/server/" + modo,
			{
				id : "test",
				key : "prova"
			},
			function(data, status) {
				var updateOutput = function(e) {
					var list = e.length ? e : $(e.target), output = list
							.data('output');
					if (window.JSON) {
						output.val(window.JSON.stringify(list
								.nestable('serialize')));//, null, 2));
					} else {
						output.val('JSON browser support required.');
					}
				};
				$('#nestable-output-' + modo.substring(0, 4)).val(JSON.stringify(data));
//				alert("Data: " + JSON.stringify(data) + "\nStatus: " + status);
				var json2 = eval(data);
//				alert("Data: " + JSON.stringify(json));
				var buttonEdit
				= '<div class="btn-group float-right jamButton">'
				+ '<a title="Add Row Below" class="btn btn-secondary btn-sm clickable" '
				+ 'data-action="addRowBelow">'
				+ '<i class="fas fa-plus clickable"></i></a>'

//				+ '<a class="btn btn-primary btn-sm clickable" data-toggle="modal" data-target="#menuEditModal">'
				+ '<a title="Edit Row" class="btn btn-secondary btn-sm clickable" '
				+ 'data-action="editRow">'
				+ '<i class="fas fa-edit clickable"></i></a>'

				+ '<a class="btn btn-danger btn-sm clickable" data-action="removeRow">'
				+ '<i class="fas fa-trash-alt clickable"></i></a></div>';

				$('#nestable-' + modo.substring(0, 4)).nestable({
					group : 1,
					json : json2,
					buttonEdit : buttonEdit,
					inputField : 'New Item',
					contentCallback : function(item) {
						var content = ''; //item.content || '' ? item.content : item.id;
						if (item.tt == 'pane') {
							content += ''
//									+ '<i class="fas fa-address-card"></i>'
									+ ' id: <input class="jamEdit inputField" style="width:100px" '
									+ ' value="' + item.id +'"></input>'
									+ ' tit: <input class="jamEdit inputField2" style="width:100px" '
									+ '	value="' + item.tit +'"></input>';
						} else if (item.tt == 'item') {
							content += '' // item.id
//									+ '<i class="fas fa-equals"></i>'
									+ ' id: <input class="jamEdit inputField" style="width:120px" value="'
									+ item.ix +'"></input>'
									+ ' tit: <input class="jamEdit inputField2" style="width:100px" '
									+ '	value="' + item.tit +'"></input>';
								+ item.ix +'"></input>';
						} else if (item.tt == 'att:type') {
							content += '' // item.id
//									+ '<i class="fas fa-equals"></i>'
//									+ ' type: <input class="jamEdit inputField" style="width:120px" value="'
//									+ item.type +'"></input>'

									+ ' type: <select id="type" name="type" class="inputField" >'
									+ '<option value="text" selected="text">Text</option>'
									+ '<option value="intero">Intero</option>'
									+ '<option value="decimal">Decimal</option>'
									+ '<option value="data">Data</option>'
									+ '</select>'

									+ ' val: <input class="jamEdit inputField2" style="width:100px" '
									+ '	value="' + item.val +'"></input>';
								+ item.ix +'"></input>';
						} else
							content += ' '
									+ '<input class="jamEdit inputField" style="width:200px" value="'
									+ item.ix +'"></input>';

							content += buttonEdit;
						return content;
					}
				}).on('change',function() {
					updateOutput($('#nestable-' + modo.substring(0, 4))
						.data('output',$('#nestable-output-'+ modo.substring(0, 4))));

					$('.inputField').off();

					$('.inputField').on('focusout',function() {
						$('#nestable-' + modo.substring(0, 4)).trigger("change");
					});
				});
			});
//			$('.dd').nestable('collapseAll'); // non va
			return cc;
		};

		$("#save").click(function() {
			var message = $("#nestable-output-load").val();
//			alert(message);
//			$.get("/Jam5/server/save", {id : "test", key : "prova"
//			}, function(data, status) {});

			var xhr = new XMLHttpRequest();
			var url = "/Jam5/server/save"; //?data=" + encodeURIComponent(message);
			xhr.open("POST", url, true);
//			xhr.setRequestHeader("Content-Type", "application/json");
			xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			xhr.send("data=" + encodeURIComponent(message));
/*			xhr.onreadystatechange = function () {
			 if (xhr.readyState === 4 && xhr.status === 200) {
			 var json = JSON.parse(xhr.responseText);
			 alert(json.email + ", " + json.password);
			 }
			 };*/
//&			xhr.send();
		});
	</script>

	<script>
		$(document).ready(function() {
			$('#nestable-menu').on('click', function(e) {
				var target = $(e.target), action = target.data('action');
				if (action === 'expand-all') {
					$('.dd').nestable('expandAll');
				}
				if (action === 'collapse-all') {
					$('.dd').nestable('collapseAll');
				}
				if (action === 'add-item') {
					var newItem = {
						"id" : ++lastId,
						"content" : "Item " + lastId,
						"children" : [ {
							"id" : ++lastId,
							"content" : "Item " + lastId,
							"children" : [ {
								"id" : ++lastId,
								"content" : "Item " + lastId
							} ]
						} ]
					};
					$('#nestable').nestable('add', newItem);
				}
				if (action === 'replace-item') {
					var replacedItem = {
						"id" : 10,
						"content" : "New item 10",
						"children" : [ {
							"id" : ++lastId,
							"content" : "Item " + lastId,
							"children" : [ {
								"id" : ++lastId,
								"content" : "Item " + lastId
							} ]
						} ]
					};
					$('#nestable').nestable('replace', replacedItem);
				}
			});

			$('#nestable3').nestable({
				group : 1
			});

		});
	</script>
	<script>
		$(document).ready(function() {
			$(".select2").on("select2:open",function() {
				alert('test');
				$(".select2-results").css("visibility","hidden");
			});
			$(".select2").on('select2:opening',function() {
				alert('test');
				setTimeout(function() {
					$(".select2-results").css("visibility", "visible");}, 400); });
	
			$('#item-select').select2({
//				theme: 'bootstrap4',
				allowClear : true,
				placeholder : "Choose Pane ...",
				ajax : {
//					url: "http://sh-example-simple.herokuapp.com",
					url : "/Jam5/server/get?pane=TD01_FAT",
					dataType : "json",
					width : 'style',
					delay : 250,
					data : function(params) {
						return {
							q : params.term,
							page : params.page,
							per_page : 20
						};
					},
					processResults : function(
							data, page) {
						return {
		// Select2 requires an id, so we need to map the results and add an ID
		// You could instead include an id in the tsv you add to soulheart ;)
							results : data.matches
									.map(function(
											item) {
										return {
											id : item.id,
											text : item.text
										};
									}),
							pagination : {
		// If there are 10 matches, there's at least another page
								more : data.matches.length === 10
							}
						};
					},
					cache : true
				},
//				minimumInputLength: 1,
				templateResult : formatRepo,
				templateSelection : formatRepoSelection
			});

			function formatRepo2(repo) {
//				if(repo.loading) {
				return repo.id + '\t' + repo.text;
//				}
			}

			var firstEmptySelect = true; // Indicate header was create

			function formatRepo(item) {

				if (!item.id) {
					// trigger when remote query
					firstEmptySelect = true; // reset
					return item.text;
				}

				var $container; // This is custom templete container.

				// Create header
				if (firstEmptySelect) {

					firstEmptySelect = false;

					$container = $('<div class="row" '
						+ 'style=\"margin:0;flex-wrap:nowrap;\">'
						+ '<div><a class="btn btn-success">Clienti</a></div>'
						+ '<div><a class="btn btn-success">Fornitori</a></div>'
						+ '</div>'
						+ '<div class="row" style=\"margin:0;flex-wrap:nowrap;\">'
						+ '<div class="col-md-1"><b>ID</b></div>'
						+ '<div class="col-md-5"><b>Name</b></div>'
						+
//	            			'</div>' +
//	                    	'<div class="row" style=\"margin:0\">' +
//	                    	'<div class="col-md-1">' + item.id + '</div>' +
//	                    	'<div class="col-md-5">' + item.text + '</div>' +
							'</div>');

				} else {
					$container = $('<div class="row" style=\"margin:0;flex-wrap:nowrap;\">'
						+ '<div class="col-md-1">'
						+ item.id
						+ '</div>'
						+ '<div class="col-md-5">'
						+ item.text + '</div>' + '</div>');
				}

				return $container
			}

			function formatRepoSelection(repo) {
				return repo.id + " - " + repo.text;
			}

		});
	</script>
<!-- 
	<div>
		<style>
		.dd-edit-box input {
			border: none;
			background: transparent;
			outline: none;
			font-size: 13px;
			color: #444;
			text-shadow: 0 1px 0 #fff;
			width: 45%;
		}
		
		.dd-edit-box {
			position: relative;
		}
		
		.dd-edit-box i {
			right: 0;
			overflow: hidden;
			cursor: pointer;
			position: absolute;
		}
		
		.dd-item-blueprint {
			display: none;
		}
		</style>

		<div class="dd2" id="domenu">
			<button class="dd-new-item">+</button>
			<li class="dd-item-blueprint">
				<div class="dd-handle dd3-handle"></div>
				<div class="dd3-content">
					<span>[item_name]</span>
					<button class="item-remove">&times;</button>
					<div class="dd-edit-box" style="display: none;">
						<input type="text" name="title" placeholder="name"> <input
							type="url" name="http" placeholder="http://"> <i>&#x270e;</i>
					</div>
				</div>
			</li>
			<ol class="dd-list"></ol>
		</div>

		<script src="jquery.domenu-0.0.1.js"></script>

		<script>
			$(document).ready(function() {
				var updateOutput = function(e) {
					var list = e.length ? e : $(e.target), output = list
							.data('output');
					if (window.JSON) {
						output.val(window.JSON.stringify(list
								.nestable('serialize')));//, null, 2));
					} else {
						output.val('JSON browser support required for this demo.');
					}
				};

				$('#domenu').domenu({
					data : '[{"id":11,"title":"Item 11","http":""},{"id":10,"title":"Item 10","http":""},{"id":9,"title":"Item 9","http":""},{"id":6,"title":"Home","http":"","children":[{"id":5,"title":"Item 5","http":""},{"id":4,"title":"Item 4","http":"","children":[{"id":3,"title":"Item 3","http":""},{"id":2,"title":"Item 2","http":"","children":[{"id":7,"title":"Example","http":"http://google.com"},{"id":8,"title":"Item 8","http":""}]}]}]},{"id":1,"title":"Item 1","http":""}]'
				}).parseJson();
			});
		</script>

	</div>
	 -->

	<script>
		$(document).ready(function() {
			var editor = carica('load');
			// icon picker options
			var iconPickerOptions = {
				searchText : "Icona ...",
				labelHeader : "{0}/{1}"
			};
/*
			var editor = new MenuEditor('myEditor', {
				listOptions : sortableListOptions,
				iconPicker : iconPickerOptions
			});
*/
			$('#btnReload').on('click', function() {
				editor.setData(arrayjson);
			});

			$("#btnUpdate").click(function() {
				editor.update();
			});

			$('#btnAdd').click(function() {
				editor.add();
			});

			/* PRIVATE METHODS */
		    function editItem($item) {
		        var data = $item.data();
		        $.each(data, function (p, v) {
		            $form.find("[name=" + p + "]").val(v);
		        });
		        $form.find(".item-menu").first().focus();
		        if (data.hasOwnProperty('icon')) {
		            iconPicker.iconpicker('setIcon', data.icon);
		        } else{
		            iconPicker.iconpicker('setIcon', 'empty');
		        }
		        $updateButton.removeAttr('disabled');
		    }

		    function resetForm() {
		        $form[0].reset();
		        iconPicker = iconPicker.iconpicker(iconPickerOpt);
		        iconPicker.iconpicker('setIcon', 'empty');
		        $updateButton.attr('disabled', true);
		        itemEditing = null;
		    }
		    /* PUBLIC METHODS */
		    setForm = function(form){
		        $form = form;
		    };

		    getForm = function(){
		        return $form;
		    };

		    setUpdateButton = function($btn){
		        $updateButton = $btn;
		        $updateButton.attr('disabled', true);
		        itemEditing = null;
		    };

		    getUpdateButton = function(){
		        return $updateButton;
		    };

		    getCurrentItem = function(){
		        return itemEditing;
		    };

		    update = function(){
		        var $cEl = this.getCurrentItem();
		        if ($cEl===null){
		            return;
		        }
		        var oldIcon = $cEl.data('icon');
		        $form.find('.item-menu').each(function(){
		            $cEl.data($(this).attr('name'), $(this).val());
		        });
		        $cEl.children().children('i').removeClass(oldIcon).addClass($cEl.data('icon'));
		        $cEl.find('span.txt').first().text($cEl.data('text'));
		        resetForm();
		    };

			setForm($('#frmEdit'));
			setUpdateButton($('#btnUpdate'));

		});
	</script>
</body>
</html>
